(()=>{function g(e,t,n){return $("<table>",{class:t,id:n}).appendTo(e)}function h(e){return $("<tr>").appendTo(e)}function d(e,t,n){var o=$("<td>",{class:t,id:n});return o.appendTo(e),o}function w(e,t,n,o,r){let a=[];for(let l=0;l<2;l++){let i=h(e),c=h(e);d(i,"empty-td",null),d(c,"description-td",null).text("\u9673\u5217\u4F4D");let s=o+l*r,f=t.slice(s,s+r),{storeCells:u,imageCells:I}=E(f,n,i,c);if(F(i,c,r-f.length),a.push({storeCells:u,imageCells:I.filter(k=>k!==null)}),t.length<=s+r)break}return a}function X(e,t){let n=$("<img>").attr("src","data:image/png;base64,"+t).css({width:"100%",height:"100%"});e.empty().append(n)}function E(e,t,n,o){let r=[],a=[];return e.forEach(l=>{let i=t.get(l.rowId)||null,c=`store-${l.rowId}`,s=`photo-${l.rowId}`,f=d(n,"store-td",c).text(l.store);if(r.push(f),i){let u=d(o,"photo-td",s);X(u,i),a.push(u)}else{let u=d(o,"photo-td",s).text("\u7121\u5716\u50CF");a.push(u)}}),{storeCells:r,imageCells:a}}function F(e,t,n){for(let o=0;o<n;o++)d(e,"store-td",null).text("\u7121\u8CC7\u6599"),d(t,"photo-td",null).text("\u7121\u5716\u50CF")}function S(e,t){let n=e[0];return Array.from({length:Math.ceil((e.length-1)/t)},(o,r)=>[n,...e.slice(r*t+1,r*t+1+t)])}function y(e,t){let n=new Map,o=new Set;return t.getImages().forEach(r=>{let a=e.model.media.find(i=>i.index===r.imageId),l=r.range.tl.nativeRow+1;o.has(l)||(o.add(l),n.set(l,a.buffer.toString("base64")))}),n}function x(e){let t=[],n=[];return e.eachRow({includeEmpty:!0},(o,r)=>{let a=[4,7,8].map(l=>o.getCell(l).value||null);a.every(l=>l)&&(t.push(a.map((l,i)=>({text:l,options:{fill:i===0?"99cdff":"b5c7dd"}}))),n.push({rowId:r,store:a[0]}))}),{displayData:t,storeData:n}}function m(e){let t=0,n=1;return e.eachRow({includeEmpty:!0},o=>{[4,7,8].map(a=>o.getCell(a).value||null).every(a=>a)&&t++}),t-n}var p=new PptxGenJS;function L(e){S(e,10).forEach(o=>{p.addSlide().addTable(o,{align:"left",valign:"middle",fontSize:18,colW:[2.2,5.2,1.7],rowH:.35,border:{pt:"1",color:"FFFFFF"}})})}function R(e){let t=[];return e.tables.forEach((n,o)=>{let r=document.getElementById(n.id);if(!r){console.error(`Table-id ${n.id} empty.`);return}let a=n.rows.length<2?"50%":"100%",l=domtoimage.toPng(r).then(i=>{p.addSlide().addImage({data:i,w:"100%",h:a})}).catch(i=>{console.error(`Error table-id ${n.id}:`,i)});t.push(l)}),Promise.all(t)}var b=0;function B(e,t,n,o=6){n.shift();let r=y(e,t),a=[];for(let l=0;l<n.length;l+=o*2){let i=`${t.name}-photo-table-${b}`;b++;let c=g($("#pptTableContainer"),"photo-table",i),s=w(c,n,r,l,o);a.push({id:i,rows:s,rowCount:s.length,columnCount:o})}return{tables:a}}function M(){p.addSlide().addText([{text:"\u5357\u50D1\u6C34\u6676",options:{fontFace:"\u6A19\u6977\u9AD4",fontSize:54,color:"000000",breakLine:!0,align:"center",valign:"middle"}},{fontFace:"\u6A19\u6977\u9AD4",text:`PX113${(new Date().getMonth()+1).toString().padStart(2,"0")}`,options:{fontSize:60,color:"000000",breakLine:!0,align:"center",valign:"middle"}},{fontFace:"\u6A19\u6977\u9AD4",text:"DM\u5546\u54C1\u7B2C\u4E8C\u9673\u5217",options:{fontSize:60,color:"000000",align:"center",valign:"middle"}}],{h:"100%",w:"100%"})}function z(e){let t=[],n={fontFace:"\u6A19\u6977\u9AD4",fontSize:32,color:"000000",breakLine:!0,align:"center",valign:"middle"},o=0;return e.eachSheet(r=>{o+=m(r),t.push({text:`${r.name}\u7B2C\u4E8C\u9673\u5217\u5E97\u5BB6-\u5171${m(r)}\u5BB6`,options:n})}),t.push({text:`\u76EE\u524D\u9673\u5217${o}\u5BB6(\u6301\u7E8C\u66F4\u65B0\u4E2D)`,options:n}),t}function A(e){p.addSlide().addText(e,{h:"100%",w:"100%"})}async function N(e,t,n,o){t.length>1?L(t):console.log("\u7121\u9673\u5217\u5E97\u5BB6\u8CC7\u6599"),e.length>1?await R(B(n,o,e)):console.log("\u7121\u9673\u5217\u7167\u7247")}async function V(e){let t=[];e.eachSheet(n=>{let o=x(n);t.push(N(o.storeData,o.displayData,e,n))}),await Promise.all(t)}function Q(){p.writeFile({fileName:`PX${new Date().getFullYear()-1911}\u5E74${new Date().getMonth()+1}\u6708\u4EFD\u9673\u5217\u7167\u7247.pptx`}),Swal.fire({title:"\u5DF2\u6210\u529F\u8F49\u63DB\u4E0B\u8F09PPT",icon:"success"})}async function C(e){M(),A(z(e)),await V(e),Q()}function P(e,t){let n={...e,...t};return Object.keys(n).map(o=>`${o}: ${n[o]};`).join(" ")}function v({id:e,text:t,styles:n}){let o=P([],n);return`
          <div class="file-input">
              <input type="file" name="${e}" id="${e}" class="file-input-input">
              <label class="file-input-label" for="${e}" style="${o}">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="upload" class="svg-inline--fa fa-upload fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <path fill="currentColor" d="M296 384h-80c-13.3 0-24-10.7-24-24V192h-87.7c-17.8 0-26.7-21.5-14.1-34.1L242.3 5.7c7.5-7.5 19.8-7.5 27.3 0l152.2 152.2c12.6 12.6 3.7 34.1-14.1 34.1H320v168c0 13.3-10.7 24-24 24zm216-8v112c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V376c0-13.3 10.7-24 24-24h136v8c0 30.9 25.1 56 56 56h80c30.9 0 56-25.1 56-56v-8h136c13.3 0 24 10.7 24 24zm-124 88c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20zm64 0c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20z"></path>
                    </svg>
                  <span>${t}</span>
              </label>
          </div>
      `}function T(e){return e&&e.name.split(".").pop().toLowerCase()==="xlsx"}function D(e){return T(e)?!0:(Swal.fire({title:"\u4E0D\u652F\u63F4\u7684\u6A94\u6848\u985E\u578B\uFF0C\u5FC5\u9808\u662F XLSX \u6A94!",icon:"error"}),!1)}$(document).ready(function(){function e(){$(".top-row").append(v({id:"xlsx2ppt",text:"PPT",styles:{background:"#d04424"}}))}e(),$("#xlsx2ppt").on("change",function(){var t=this.files[0];if(!D(t)){$(this).val("");return}Pace.restart();let n=new FileReader;n.onloadend=async function(){let o=new ExcelJS.Workbook;await o.xlsx.load(n.result),C(o),Pace.stop()},n.readAsArrayBuffer(t)})});})();
