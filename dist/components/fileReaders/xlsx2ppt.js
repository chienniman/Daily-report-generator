(()=>{function g(t,e,n){return $("<table>",{class:e,id:n}).appendTo(t)}function h(t){return $("<tr>").appendTo(t)}function d(t,e,n){var o=$("<td>",{class:e,id:n});return o.appendTo(t),o}function S(t,e,n,o,r){let a=[];for(let l=0;l<2;l++){let c=h(t),s=h(t);d(c,"empty-td",null),d(s,"description-td",null).text("\u9673\u5217\u4F4D");let i=o+l*r,p=e.slice(i,i+r),{storeCells:u,imageCells:D}=X(p,n,c,s);if(F(c,s,r-p.length),a.push({storeCells:u,imageCells:D.filter(I=>I!==null)}),e.length<=i+r)break}return a}function E(t,e){let n=$("<img>").attr("src","data:image/png;base64,"+e).css({width:"100%",height:"100%"});t.empty().append(n)}function X(t,e,n,o){let r=[],a=[];return t.forEach(l=>{let c=e.get(l.rowId)||null,s=`store-${l.rowId}`,i=`photo-${l.rowId}`,p=d(n,"store-td",s).text(l.store);if(r.push(p),c){let u=d(o,"photo-td",i);E(u,c),a.push(u)}else{let u=d(o,"photo-td",i).text("\u7121\u5716\u50CF");a.push(u)}}),{storeCells:r,imageCells:a}}function F(t,e,n){for(let o=0;o<n;o++)d(t,"store-td",null).text("\u7121\u8CC7\u6599"),d(e,"photo-td",null).text("\u7121\u5716\u50CF")}function w(t,e){let n=t[0];return Array.from({length:Math.ceil((t.length-1)/e)},(o,r)=>[n,...t.slice(r*e+1,r*e+1+e)])}function y(t,e){let n=new Map,o=new Set;return e.getImages().forEach(r=>{let a=t.model.media.find(c=>c.index===r.imageId),l=r.range.tl.nativeRow+1;o.has(l)||(o.add(l),n.set(l,a.buffer.toString("base64")))}),n}function b(t){let e=[],n=[];return t.eachRow({includeEmpty:!0},(o,r)=>{let a=[4,7,8].map(l=>o.getCell(l).value||null);a.every(l=>l)&&(e.push(a.map((l,c)=>({text:l,options:{fill:c===0?"99cdff":"b5c7dd"}}))),n.push({rowId:r,store:a[0]}))}),{displayData:e,storeData:n}}function m(t){let e=0,n=1;return t.eachRow({includeEmpty:!0},o=>{[4,7,8].map(a=>o.getCell(a).value||null).every(a=>a)&&e++}),e-n}var f=new PptxGenJS;function R(t){w(t,10).forEach(o=>{f.addSlide().addTable(o,{align:"left",valign:"middle",fontSize:18,colW:[2.2,5.2,1.7],rowH:.35,border:{pt:"1",color:"FFFFFF"}})})}function L(t){let e=[];return t.tables.forEach((n,o)=>{let r=document.getElementById(n.id);if(!r){console.error(`Table-id ${n.id} empty.`);return}let a=n.rows.length<2?"50%":"100%",l=domtoimage.toPng(r).then(c=>{f.addSlide().addImage({data:c,w:"100%",h:a})}).catch(c=>{console.error(`Error table-id ${n.id}:`,c)});e.push(l)}),Promise.all(e)}var x=0;function B(t,e,n,o=6){n.shift();let r=y(t,e),a=[];for(let l=0;l<n.length;l+=o*2){let c=`${e.name}-photo-table-${x}`;x++;let s=g($("#pptTableContainer"),"photo-table",c),i=S(s,n,r,l,o);a.push({id:c,rows:i,rowCount:i.length,columnCount:o})}return{tables:a}}function M(){f.addSlide().addText([{text:"\u5357\u50D1\u6C34\u6676",options:{fontFace:"\u6A19\u6977\u9AD4",fontSize:54,color:"000000",breakLine:!0,align:"center",valign:"middle"}},{fontFace:"\u6A19\u6977\u9AD4",text:`PX113${(new Date().getMonth()+1).toString().padStart(2,"0")}`,options:{fontSize:60,color:"000000",breakLine:!0,align:"center",valign:"middle"}},{fontFace:"\u6A19\u6977\u9AD4",text:"DM\u5546\u54C1\u7B2C\u4E8C\u9673\u5217",options:{fontSize:60,color:"000000",align:"center",valign:"middle"}}],{h:"100%",w:"100%"})}function z(t){let e=[],n={fontFace:"\u6A19\u6977\u9AD4",fontSize:32,color:"000000",breakLine:!0,align:"center",valign:"middle"},o=0;return t.eachSheet(r=>{o+=m(r),e.push({text:`${r.name}\u7B2C\u4E8C\u9673\u5217\u5E97\u5BB6-\u5171${m(r)}\u5BB6`,options:n})}),e.push({text:`\u76EE\u524D\u9673\u5217${o}\u5BB6(\u6301\u7E8C\u66F4\u65B0\u4E2D)`,options:n}),e}function A(t){f.addSlide().addText(t,{h:"100%",w:"100%"})}async function N(t,e,n,o){e.length>1?R(e):console.log("\u7121\u9673\u5217\u5E97\u5BB6\u8CC7\u6599"),t.length>1?await L(B(n,o,t)):console.log("\u7121\u9673\u5217\u7167\u7247")}async function Q(t){let e=[];t.eachSheet(n=>{let o=b(n);e.push(N(o.storeData,o.displayData,t,n))}),await Promise.all(e)}function V(){f.writeFile({fileName:`PX${new Date().getFullYear()-1911}\u5E74${new Date().getMonth()+1}\u6708\u4EFD\u9673\u5217\u7167\u7247.pptx`}),Swal.fire({title:"\u5DF2\u6210\u529F\u8F49\u63DB\u4E0B\u8F09PPT",icon:"success"})}async function C(t){M(),A(z(t)),await Q(t),V()}function P(t,e){let n={...t,...e};return Object.keys(n).map(o=>`${o}: ${n[o]};`).join(" ")}function v({id:t,text:e,styles:n}){let o=P([],n);return`
          <div class="file-input">
              <input type="file" name="${t}" id="${t}" class="file-input-input">
              <label class="file-input-label" for="${t}" style="${o}">
                    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="upload" class="svg-inline--fa fa-upload fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <path fill="currentColor" d="M296 384h-80c-13.3 0-24-10.7-24-24V192h-87.7c-17.8 0-26.7-21.5-14.1-34.1L242.3 5.7c7.5-7.5 19.8-7.5 27.3 0l152.2 152.2c12.6 12.6 3.7 34.1-14.1 34.1H320v168c0 13.3-10.7 24-24 24zm216-8v112c0 13.3-10.7 24-24 24H24c-13.3 0-24-10.7-24-24V376c0-13.3 10.7-24 24-24h136v8c0 30.9 25.1 56 56 56h80c30.9 0 56-25.1 56-56v-8h136c13.3 0 24 10.7 24 24zm-124 88c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20zm64 0c0-11-9-20-20-20s-20 9-20 20 9 20 20 20 20-9 20-20z"></path>
                    </svg>
                  <span>${e}</span>
              </label>
          </div>
      `}function T(t){return t&&t.name.split(".").pop().toLowerCase()==="xlsx"}function k(t){return T(t)?!0:(Swal.fire({title:"\u4E0D\u652F\u63F4\u7684\u6A94\u6848\u985E\u578B\uFF0C\u5FC5\u9808\u662F XLSX \u6A94!",icon:"error"}),!1)}$(document).ready(function(){function t(){$(".top-row").append(v({id:"xlsx2ppt",text:"PPT",styles:{background:"#d04424"}}))}t(),$("#xlsx2ppt").on("change",function(){var e=this.files[0];if(!k(e)){$(this).val("");return}Pace.restart();let n=new FileReader;n.onloadend=async function(){let o=new ExcelJS.Workbook;await o.xlsx.load(n.result),C(o),Pace.stop()},n.readAsArrayBuffer(e)})});})();
